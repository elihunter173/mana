TODO: Compute spans and types lazily I think
